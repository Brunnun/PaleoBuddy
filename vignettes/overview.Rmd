---
title: "overview"
author: Bruno do Rosario Petrucci
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Paleobuddy: Simulating diversity dynamics

`paleobuddy` is an R package for species birth-death simulation, complete with the possibility of generating phylogenetic trees and fossil records from the results. The package offers unprecedented flexibility in the choice of speciation, extinction and sampling rates, as we will showcase in this vignette. 

The biggest reason to write and publish a simulator is to effectively test rate estimation methods with scenarios whose true dynamics are known. This leads to an intuitive overview of the package: in this vignette, we will first generate a couple of useful scenarios to show use cases of the package. Then, we will discuss the choice of rates further, detailing the customization capabilities of both the birth-death and sampling functions. Finally, we will conclude going over the shortcomings of the package, including the features we plan to implement in the future. As new versions are released, this document will be updated to reflect the newest features.

First we do some setup.

```{r results = "hide"}
# importing the package functions
library(paleobuddy)
```

## Constant rate birth-death: a use case with phytools

Let us first try the simplest possible birth-death scenario - constant speciation and extinction rates. We will then use `phytools` to attempt an estimate of rates.

First we use the function `bd.sim`, the main birth-death simulator in the package, to generate a group.

```{r}
# we set a seed so the results are reproducible
set.seed(1)

# set the necessary parameters
# initial number of species
n0 <- 1

# speciation rate - approx. 1 speciation event every 5my
# we are trying to create a big phylogeny so phytools can function better
pp <- 0.25

# extinction rate - approx. 1 extinction event every 10my
qq <- 0.15

# maximum simulation time - species that die after this are considered extant
tMax <- 50

# run the simulation
sim <- bd.sim(n0, pp, qq, tMax)

# take a look at the way the result is organized
sim
```

The output of `bd.sim` is a list of named vectors that is organized as follows
* `TE` a list of extinction times. For an extant species, the extinction time is `-0.01`.
* `TS` a list of speciation times. For species alive at the beginning of the simulation, the speciation time is `tMax + 0.01`.
* `PAR` a list of parents. The naming of species follows the order of `TE` and `TS`, i.e. if `PAR[i] == 1`, the species whose speciation time is `TS[1]` generated species `i`.
* `EXTANT` a list of booleans indicating whether a species is alive at the end of the simulation or not. Note this could be extrapolated from the information in `TE`, but we present it for practicality's sake.

Using this object, or one generated by `bd.sim.constant` or `bd.sim.general`, the helper functions `bd.sim` calls, we can generate a phylogenetic tree using `make.phylo`.

```{r}
# there are currently not many customization options for phylogenies
phy <- make.phylo(sim)

# plot it with APE - hide tip labels since there are a lot so it looks cluttered
ape::plot.phylo(phy, show.tip.label = FALSE)
ape::axisPhylo()

# plot the molecular phylogeny
ape::plot.phylo(ape::drop.fossil(phy), show.tip.label = FALSE)
ape::axisPhylo()
```

From here, we could use this phylogeny to run `phytools` and get an estimate of the speciation and extinction rate.

```{r eval=FALSE}
# find the fit
fit <- phytools::fit.bd(ape::drop.fossil(phy))

# get the birth and death rate
b <- fit$b
d <- fit$d
```

We set this to not run so that we do not need to add phytools as an Import in the package, but the results were approximately `b = 0.21` and `d = 0.22`. As we can see, `phytools` overestimated extinction and underestimated speciation, something common since there are two independent processes going on, births and deaths. A phylogeny with more species could lead to more accurate results, and of course if we were conducting a thorough test of `phytools` we would generate hundreds or thousands of phylogenies.

For illustration, we create a simulation with more than 1000 tips, with 547 extant tips.

```{r}
# set a seed
set.seed(2)

# create simulation
# note nFinal and extOnly, defining we want 200 ormore extant species at the end
sim <- bd.sim(n0, pp, qq, tMax, nFinal = c(200, Inf), extOnly = TRUE)

# check the number of extant species
sum(sim$EXTANT)
```

We can then run this through `phytools` as before

```{r eval=FALSE}
# find the fit
fit <- phytools::fit.bd(ape::drop.fossil(make.phylo(sim)))
```

This yields a warning, because of the gigantic phylogeny, but also yields `b = 0.25` and `d = 0.12`. Pretty great fits, especially when considering how challenging it is to estimate extinction rates with a molecular phylogeny, and the fact we conditioned the results when we asked `bd.sim` to only give us a simulation with 200 or more extant species.

## Linear speciation and extinction: a use case with \\\

One of the pluses of `paleobuddy` is that we can generate both fossil records and phylogenies in independent processes, both coming from the same underlying birth-death simulations. We will here use the fossil record generating functions of `paleobuddy` to generate an incomplete fossil record and run it through \\\ to evaluate the birth-death rate fit.

As before, start with a simulation

```{r}
# we set a seed so the results are reproducible
set.seed(5)

# set the necessary parameters
# initial number of species
n0 <- 1

# speciation rate - it can be any function of time!
pp <- function(t) {
  0.1 + 0.001*t
}

# extinction rate - also can be any function of time
qq <- function(t) {
  0.03 * exp(-0.01*t)
}

# maximum simulation time - species that die after this are considered extant
tMax <- 50

# run the simulation
sim <- bd.sim(n0, pp, qq, tMax)

# check the resulting clade out
ape::plot.phylo(make.phylo(sim), show.tip.label = FALSE)
```
A lot of species! We can then create a fossil record from this group.

```{r}
# again set a seed
set.seed(1)

# set the sampling rate
# using a simple case - there will be on average T occurrences per species,
# where T is the species duration
rr <- 1

# run the sampling simulation only for the first 10 species for brevity's sake
samp <- suppressMessages(sample.clade(S = 1:10, sim = sim, rr = rr, tMax = tMax))
# suppressing messages - the message is to inform the user how many species
# left no fossils. In this case, it was 0

# take a look at how the output is organized
head(samp)
```

The output of `sample.clade` is a data frame organized as follows
* `Species` the species name, usually `spp_` followed by the number in the order it is organized on `sim`.
* `Extant` whether the species is extant or not.
* `minT` the lower bound of the geologic range the fossil is found. The range vectors is an input, `bins`, used to simulate the granularity of the fossil record. If not provided, `bins` will go from `tMax` to `0` by `-0.01`.
* `maxT` the upper bound of the geologic range the fossil is found.

This data frame organization allows for easy evaluation of its components, and is close to ready for use in PyRate, one of the most widely used birth-death rates estimator in the field currently. To make it ready we must manipulate the `Extant` column, left like this for clarity. In PyRate, that column must be `status`, with extant species marked `extant` and extinct species marked `extinct`.

```{r}
# make a copy
pSamp <- samp

# change the extant column
pSamp["Extant"][pSamp["Extant"] == FALSE] = "extant"
pSamp["Extant"][pSamp["Extant"] == TRUE] = "extinct"

# change column names
colnames(pSamp) <- c("Species", "Status", "min_age", "max_age")

# check it out
head(pSamp)
```

This data frame could be directly dropped in PyRate for rate estimations. 